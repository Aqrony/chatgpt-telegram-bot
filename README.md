# Чат-бот Telegram ChatGPT
![python-version](https://img.shields.io/badge/python-3.9-blue.svg)
[![openai-version](https://img.shields.io/badge/openai-0.27.2-orange.svg)](https://openai.com/)
[![license](https://img.shields.io/badge/License-GPL%202.0-brightgreen.svg)](LICENSE)
[![Publish Docker image](https://github.com/n3d1117/chatgpt-telegram-bot/actions/workflows/publish.yaml/badge.svg)](https://github.com/n3d1117/chatgpt-telegram-bot/actions/workflows/publish.yaml)

[Telegram-бот](https://core.telegram.org/bots/api), который интегрируется с API [ChatGPT](https://openai.com/blog/chatgpt/) от OpenAI для предоставления ответов. Готов к использованию с минимальной настройкой.

## Скриншоты
![demo](https://user-images.githubusercontent.com/11541888/225114786-0d639854-b3e1-4214-b49a-e51ce8c40387.png)

## Функциональность
- [x] Поддержка Markdown в ответах
- [x] Сброс конверсации с помощью команды `/reset`
- [x] Индикатор набора при генерации ответа
- [x] Доступ может быть ограничен путем указания списка разрешенных пользователей
- [x] Поддержка Docker и Proxy
- [x] (НОВОЕ!) Генерация изображения с использованием DALL·E через команду `/image`
- [x] (НОВОЕ!) Транскрипция аудио- и видеосообщений с помощью Whisper (может потребоваться [ffmpeg](https://ffmpeg.org))
- [x] (НОВОЕ!) Автоматическая сводка разговора для предотвращения избыточного использования токенов (исправление [#34](https://github.com/n3d1117/chatgpt-telegram-bot/issues/34))
- [x] (НОВОЕ!) Поддержка группового чата с встроенными запросами 
  - Чтобы использовать эту функцию, включите встроенные запросы для своего бота в BotFather через команду `/setinline` [command](https://core.telegram.org/bots/inline)
- [x] (НОВОЕ!) Отслеживание использования токенов на пользователя - от [@AlexHTW](https://github.com/AlexHTW)
- [x] (НОВОЕ!) Получение статистики использования токенов на день/месяц на пользователя - от [@AlexHTW](https://github.com/AlexHTW)
- [x] (НОВОЕ!) Лимиты на бюджеты пользователя и гостей - от [@AlexHTW](https://github.com/AlexHTW)
- [x] (НОВОЕ!) Поддержка потоковой передачи
- [x] (НОВОЕ!) Поддержка GPT-4
  - Если у вас есть доступ к API GPT-4, просто измените параметр `OPENAI_MODEL` на `gpt-4`

## Дополнительные функции - требуются помощь!
If you'd like to help, check out the [issues](https://github.com/fisuri/chatgpt-telegram-bot/issues) section and contribute!

PR всегда приветствуются!

## Предварительные требования
- Python 3.9+
- [Telegram bot](https://core.telegram.org/bots#6-botfather) и его токен (см. [руководство](https://core.telegram.org/bots/tutorial#obtain-your-bot-token))
- Учетная запись [OpenAI](https://openai.com) (см. раздел [конфигурации](#configuration))

## Начало работы

### Конфигурация
Скопируйте `accounts.json.example` и переименуйте его в `accounts.json`.

Настройте конфигурацию, скопировав файл `.env.example` и переименовав его в `.env` а затем отредактируйте необходимые параметры по желанию:

| Параметр                   | Описание                                                                                                                                                                                                                   |
|-----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `OPENAI_API_KEY`            | Ваш API-ключ OpenAI, который можно получить [здесь](https://platform.openai.com/account/api-keys)                                                                                                                                 |
| `TELEGRAM_BOT_TOKEN`        | Токен вашего Telegram-бота, полученный с помощью [BotFather](http://t.me/botfather) (см. [руководство](https://core.telegram.org/bots/tutorial#obtain-your-bot-token))                                                                  |
| `ADMIN_USER_IDS`            | Идентификаторы пользователей Telegram администраторов. У этих пользователей есть доступ к особым командам администратора, информации и безоговорочных ограничений бюджета. ID администратора не нужно добавлять в `ALLOWED_TELEGRAM_USER_IDS`. **Обратите внимание**: по умолчанию отсутствуют админы ('-'). |
| `ALLOWED_TELEGRAM_USER_IDS` | Список идентификаторов пользователей Telegram через запятую, которые могут взаимодействовать с ботом (используйте [getidsbot](https://t.me/getidsbot), чтобы найти идентификатор вашего пользователя). **Внимание**: по умолчанию для всех разрешено (`*`).                       |

### Настройка
| Параметр                          | Описание                                                                                                                                                                                                                      | Значение по умолчанию                  |
|------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|
| `ENABLE_QUOTING`                   | Цитирование сообщений в личных чатах                                                                                                                                                                               | true                           |
| `ENABLE_IMAGE_GENERATION`          | Включить генерацию изображений с помощью команды `/image`                                                                                                                                                                      | true                           |
| `ENABLE_TRANSCRIPTION`             | Включить транскрибирование аудио- и видеосообщений                                                                                                                                                                     | true                           |
| `MONTHLY_USER_BUDGETS`             | Список чисел через запятую, определяющих месячный бюджет по расходам на OpenAI API для каждого пользователя из списка `ALLOWED_TELEGRAM_USER_IDS`. **Примечание**: по умолчанию *нет* ограничений ни для кого (`*`)                                   | `*`                            |
| `MONTHLY_GUEST_BUDGET`             | Месячный бюджет в долларах на всех гостевых пользователей. Гостевыми пользователями являются пользователи в групповых чатах, которые **не** находятся в списке `ALLOWED_TELEGRAM_USER_IDS`. Значение игнорируется, если в бюджете на пользователя (`MONTHLY_USER_BUDGETS`="*") не заданы ограничения. | `100.0`                        |
| `PROXY`                            | Использовать прокси для OpenAI и Telegram бота (e.g. `http://localhost:8080`)                                                                                                                                                      | -                              |
| `OPENAI_MODEL`                     | Модель OpenAI, используемая для генерации ответов                                                                                                                                                                                 | `gpt-3.5-turbo`                |\n| `ASSISTANT_PROMPT`                 | Системное сообщение, устанавливающее тон и управляющее поведением помощника                                                                                                                                                   | `You are a helpful assistant.` |
| `SHOW_USAGE`                       | Показывать информацию об использовании токенов OpenAI после каждого ответа                                                                                                                                                               | false                          |
| `STREAM`                           | Производить генерацию ответов "на лету". **Примечание**: несовместимо при включенном выборе нескольких вариантов ответа (`N_CHOICES` > 1).                                                                                                                                                                                               | true                           |
| `MAX_TOKENS`                       | Верхний порог количества токенов, которые может вернуть ChatGPT API                                                                                                                                                                       | 1200                           |
| `MAX_HISTORY_SIZE`                 | Максимальное количество сообщений, которые будут храниться в памяти; после достижения этого количества диалог будет свернут, чтобы избежать избыточного использования токенов.                                                                                               | 15                             |
| `MAX_CONVERSATION_AGE_MINUTES`     | Максимальное количество минут, в течение которых диалог может жить с последнего сообщения, после которого диалог будет сброшен.                                                                                                          | 180                            |
| `VOICE_REPLY_WITH_TRANSCRIPT_ONLY` | Отвечать на голосовые сообщения только транскрипцией или ответом ChatGPT на транскрипцию                                                                                                                        | true                           |
| `N_CHOICES`                        | Количество ответов, генерируемых для каждого входного сообщения. **Примечание**: если выбрано число больше 1, то работа с ответами "на лету" будет не корректной, если включено `STREAM`.                                                                             | 1                              |
| `TEMPERATURE`                      | Число от 0 до 2. Выбор больших значений этого параметра повышает степень случайности в сгенерированном ответе                                                                                                                                                          | 1.0                            |
| `PRESENCE_PENALTY`                 | Число от -2.0 до 2.0. Значения этого параметра наказываются по наличию новых токенов и основаны на их распределении в тексте                                                                                                                                                 | 0                              |
| `FREQUENCY_PENALTY`                | Число от -2.0 до 2.0. Значения этого параметра наказываются по частоте вхождения новых токенов и основаны на их распределении в тексте                                                                                                                                                 | 0                              |
| `IMAGE_SIZE`                       | Размер сгенерированного изображения DALL·E. Допустимые значения: \"256x256", "512x512" или "1024x1024"                                                                                                                                             | "512x512"                      |
| `GROUP_TRIGGER_KEYWORD`            | Если установлен, бот в групповых чатах будет реагировать только на сообщения, начинающиеся с этого ключевого слова                                                                                                                                        | ""                             |
| `IGNORE_GROUP_TRANSCRIPTIONS`      | Если установлено значение true, бот не будет обрабатывать транскрипции в групповых чатах                                                                                                                                                           | true                           |
| `TOKEN_PRICE`                      | Цена на 1000 токенов, используемая для вычисления информации о стоимости в статистике использования (https://openai.com/pricing)                                                                                                                        | 0.002                          |
| `IMAGE_PRICES`                     | Список из 3 значений, разделенных запятыми по цене на изображения разных размеров: "256x256\", \"512x512" и "1024x1024"                                                                                                             | "0.016,0.018,0.02"             |
| `TRANSCRIPTION_PRICE`              | USD-цена за одну минуту расшифровки аудиозаписи                                                                                                                                                                                  | 0.006                          |

За более подробной информацией обращайтесь к [официальной документации API](https://platform.openai.com/docs/api-reference/chat).

### Установка
Клонируйте репозиторий и перейдите в директорию проекта:

```shell
git clone https://github.com/fisuri/chatgpt-telegram-bot.git -b main
cd chatgpt-telegram-bot
```

#### Из исходного кода
1. Создайте виртуальное окружение:
```shell
python -m venv venv
```

2. Активируйте виртуальное окружение:
```shell
# Для Linux или macOS:
source venv/bin/activate

# Для Windows:
venv\Scripts\activate
```

3. Установите зависимости, используя файл `requirements.txt`:
```shell
pip install -r requirements.txt
```

4. Используйте следующую команду для запуска бота:
```
python bot/main.py
```

#### Используя Docker Compose Запустите следующую команду для сборки и запуска Docker image:
```shell
docker compose up
```

#### Готовые Docker-образы
Вы также можете использовать Docker-образ из [Docker Hub](https://hub.docker.com/r/n3d1117/chatgpt-telegram-bot):
```shell
docker pull n3d1117/chatgpt-telegram-bot:latest
```

или из [GitHub Container Registry](https://github.com/n3d1117/chatgpt-telegram-bot/pkgs/container/chatgpt-telegram-bot/):

```shell
docker pull ghcr.io/n3d1117/chatgpt-telegram-bot:latest
```

## Благодарности

- [ChatGPT](https://chat.openai.com/chat) от [OpenAI](https://openai.com)
- [python-telegram-bot](https://python-telegram-bot.org)
- [jiaaro/pydub](https://github.com/jiaaro/pydub)

## Ограничения ответственности

Это личный проект и не связан с OpenAI.

## Лицензия

Этот проект выпущен в соответствии с условиями лицензии GPL 2.0. Более подробную информацию можно найти в файле [LICENSE](LICENSE), включенном в репозиторий.
